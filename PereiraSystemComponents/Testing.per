; TESTING -------------------------------------------------------
(defrule(true)=>(chat-local-to-self "> 9. Testing Loaded")(disable-self))

; GUARD
(defrule
    (unit-type-count monk > 0)
=>	
    (up-full-reset-search)	
    (up-find-local c: spearman-line c: 1)
	;(up-find-local c: all-units-class c: 240)	
	;(up-remove-objects search-local object-data-hitpoints < 50)
    (up-guard-unit monk c: spearman-line)
)


; REMOVE CHEAP UNITS
(defrule
	(current-age == imperial-age)
    (population-headroom == 0)
    (housing-headroom == 0)
    (wood-amount > 1000)(food-amount > 1000)(gold-amount > 1000)
    (game-time > 2100); 35 min
    (unit-type-count skirmisher-line > 0)
    (can-train hand-cannoneer)    
=>
	(delete-unit skirmisher-line)
    (train hand-cannoneer)
    (chat-local-to-self "'CHANGING' SKIRMISHERS FOR HAND CANNONEERS")
)

(defrule
	(current-age == imperial-age)
    (population-headroom == 0)
    (housing-headroom == 0)
    (wood-amount > 1300)(food-amount > 1300)(gold-amount > 1300)
    (game-time > 2100); 35 min
    (not(civ-selected gothic))(not(civ-selected japanese))    
    (unit-type-count spearman-line > 0)
    (can-train knight-line)    
=>
	(delete-unit spearman)(delete-unit pikeman)(delete-unit halberdier)
    (train knight-line)
    (chat-local-to-self "'CHANGING' SPEARMEN FOR KNIGHTS")
)

(defrule
	(not	(player-in-game any-ally))
	(unit-type-count trade-cart > 0)
=>
	(delete-unit trade-cart)
)

; USER PATCH WALL
(defconst gl-positionXisHigh 470) 
(defconst gl-positionXisMedium 471)
(defconst gl-positionXisLow 472)
(defconst gl-positionYisHigh 473) 
(defconst gl-positionYisMedium 474)
(defconst gl-positionYisLow 475)
(defconst gl-myPosition-x 476)
(defconst gl-myPosition-y 477)
(defconst gl-positionCode 478)
(defconst gl-posBorderX 479)
(defconst gl-posBorderY 480)
(defconst gl-wall-start-x 484)
(defconst gl-wall-start-y 485)
(defconst gl-wall-end-x 486)
(defconst gl-wall-end-y 487) 
(defconst gl-wall-other-end-x 488) 
(defconst gl-wall-other-end-y 489)
(defconst gl-wall-final-x 490)
(defconst gl-wall-final-y 491)
(defconst gl-center-x 492)
(defconst gl-center-y 493)
(defconst gl-mapSizeDivider1-x 501)
(defconst gl-mapSizeDivider1-y 502)
(defconst gl-mapSizeDivider2-x 503)
(defconst gl-mapSizeDivider2-y 504)
(defconst gl-mapSizeDivider3-x 505)
(defconst gl-mapSizeDivider3-y 506)
(defconst gl-mapSizeDivider4-x 507)
(defconst gl-mapSizeDivider4-y 508)
(defconst gl-mapSizeThird 509)
(defconst gl-mapSizeTwoThirds 510)

(defrule
    (true) ;just in case
=>
    (set-goal gl-positionXisHigh 0) 
    (set-goal gl-positionXisMedium 0)
    (set-goal gl-positionXisLow 0)
    (set-goal gl-positionYisHigh 0) 
    (set-goal gl-positionYisMedium 0)
    (set-goal gl-positionYisLow 0)
    (set-goal gl-myPosition-x 0)
    (set-goal gl-myPosition-y 0)
    (set-goal gl-positionCode 0)    
    (set-goal gl-wall-start-x 0)
    (set-goal gl-wall-start-y 0)
    (set-goal gl-wall-end-x 0)
    (set-goal gl-wall-end-y 0)
    (set-goal gl-wall-other-end-x 0) 
    (set-goal gl-wall-other-end-y 0)
    (set-goal gl-wall-final-x 0)
    (set-goal gl-wall-final-y 0) 
    (set-goal gl-mapSizeThird 40)         
    (set-goal gl-mapSizeTwoThirds 80) 
    (disable-self)  
)

(defrule
    (true)
=>
    (up-get-point position-self gl-myPosition-x)
    (up-get-point position-border gl-posBorderX)
    ;(up-get-point position-map-size gl-mapSizeThird)
    ;(up-get-point position-map-size gl-mapSizeTwoThirds)    
    ;(up-modify-goal gl-mapSizeThird c:/ 3)
    ;(up-modify-goal gl-mapSizeTwoThirds c:/ 3)
    ;(up-modify-goal gl-mapSizeTwoThirds c:* 2)    
    (up-chat-data-to-all "map size 1/3 %d" g: gl-mapSizeThird)
    (up-chat-data-to-all "map size 2/3 %d" g: gl-mapSizeTwoThirds)   
    (disable-self)   
)

; CHECK OUR POSITION - BASIC POINTS
; HIGH
(defrule
    (up-compare-goal gl-myPosition-x g:>= gl-mapSizeTwoThirds)
=>
    (set-goal gl-positionXisHigh 1)(disable-self)  
)
(defrule
    (up-compare-goal gl-myPosition-y g:>= gl-mapSizeTwoThirds)
=>
    (set-goal gl-positionYisHigh 1)(disable-self)  
)
; MID
(defrule
    (up-compare-goal gl-myPosition-x g:< gl-mapSizeTwoThirds)
    (up-compare-goal gl-myPosition-x g:> gl-mapSizeThird)
=>
    (set-goal gl-positionXisMedium 1)(disable-self)  
)
(defrule
    (up-compare-goal gl-myPosition-y g:< gl-mapSizeTwoThirds)
    (up-compare-goal gl-myPosition-y g:> gl-mapSizeThird)
=>
    (set-goal gl-positionYisMedium 1)(disable-self)  
)

; BOTTOM
(defrule
    (up-compare-goal gl-myPosition-x g:<= gl-mapSizeThird)
=>
    (set-goal gl-positionXisLow 1)(disable-self)  
)
(defrule
    (up-compare-goal gl-myPosition-y g:<= gl-mapSizeThird)
=>
    (set-goal gl-positionYisLow 1)(disable-self)  
)

; WE GOT THE POSITIONS
(defrule
    (false)
=>  
    (up-chat-data-to-self "MY POS X = %d" g: gl-myPosition-x)
    (up-chat-data-to-self "MY POS Y = %d" g: gl-myPosition-y)    
)

; TOP X
(defrule
    (up-compare-goal gl-positionXisHigh == 1)
    (up-compare-goal gl-positionYisHigh == 1)
=>  
    (set-goal gl-wall-start-x 80)
    (set-goal gl-wall-start-y 80)
    (set-goal gl-wall-end-x 120)
    (set-goal gl-wall-end-y 40)
    (set-goal gl-wall-other-end-x 80)
    (set-goal gl-wall-other-end-y 120)
    (set-goal gl-positionCode 1)        
    (chat-to-allies "IM AT THE EAST, IN THE CORNER!")
    (disable-self)
)

(defrule
    (true)
=>    
    (set-goal gl-mapSizeDivider1-x 80) ;north
    (set-goal gl-mapSizeDivider1-y 40)
    (set-goal gl-mapSizeDivider2-x 80) ;east
    (set-goal gl-mapSizeDivider2-y 80)
    (set-goal gl-mapSizeDivider3-x 40) ;south
    (set-goal gl-mapSizeDivider3-y 80)
    (set-goal gl-mapSizeDivider4-x 40) ;west
    (set-goal gl-mapSizeDivider4-y 40)
)

(defrule
    (up-compare-goal gl-positionXisHigh == 1)
    (up-compare-goal gl-positionYisMedium == 1)
=>  
    ;(set-goal gl-wall-start-x gl-mapSizeDivider1-x)
    (set-goal gl-wall-start-x 80)
    ;(set-goal gl-wall-start-y gl-mapSizeDivider1-y)
    (set-goal gl-wall-start-y 40)
    (set-goal gl-wall-end-x 80)    
    (set-goal gl-wall-end-y 80) 
    (set-goal gl-wall-other-end-x 120) 
    (set-goal gl-wall-other-end-y 40)    
    (set-goal gl-wall-final-x 120)
    (set-goal gl-wall-final-y 80)

    ; make wall smaller
    (up-modify-goal gl-wall-start-x c:+ 3)
    (up-modify-goal gl-wall-start-y c:+ 3)
    (up-modify-goal gl-wall-end-x c:+ 3)    
    (up-modify-goal gl-wall-end-y c:+ 3) 
    (up-modify-goal gl-wall-other-end-y c:- 3)    
    (up-modify-goal gl-wall-final-y c:+ 3)

    (set-goal gl-positionCode 2)         
    (chat-to-allies "IM AT THE NORTH EAST!")
    (disable-self)  
)

(defrule
    (up-compare-goal gl-positionXisHigh == 1)
    (up-compare-goal gl-positionYisLow == 1)
=>  
    (set-goal gl-wall-start-x 80)
    (set-goal gl-wall-start-y 40)
    (set-goal gl-wall-end-x 120)
    (set-goal gl-wall-end-y 40)
    (set-goal gl-wall-other-end-x 80)
    (set-goal gl-wall-other-end-y 0)   
    (set-goal gl-positionCode 3)       
    (chat-to-allies "IM AT AT THE NORTH, IN THE CORNER!")
    (disable-self)  
)

; CENTER X
(defrule
    (up-compare-goal gl-positionXisMedium == 1)
    (up-compare-goal gl-positionYisHigh == 1)
=>  
    (set-goal gl-wall-start-x 80)
    (set-goal gl-wall-start-y 80)
    (set-goal gl-wall-end-x 40)
    (set-goal gl-wall-end-y 80)
    (set-goal gl-wall-other-end-x 80)
    (set-goal gl-wall-other-end-y 120)
    (set-goal gl-wall-final-x 40)
    (set-goal gl-wall-final-y 120)

    ; make wall smaller
    (up-modify-goal gl-wall-start-x c:- 3)
    (up-modify-goal gl-wall-start-y c:+ 2)
    (up-modify-goal gl-wall-end-x c:+ 2)    
    (up-modify-goal gl-wall-end-y c:+ 2) 
    (up-modify-goal gl-wall-other-end-x c:- 3)    
    (up-modify-goal gl-wall-final-x c:+ 2)

    (set-goal gl-positionCode 4)     
    (chat-to-allies "IM AT THE SOUTH EAST!")
    (disable-self)
)

(defrule
    (up-compare-goal gl-positionXisMedium == 1)
    (up-compare-goal gl-positionYisMedium == 1)
=>  
    (set-goal gl-positionCode 5) 
    (chat-to-allies "IM IN THE MIDDLE OF THE MAP")
    (disable-self)
)

(defrule
    (up-compare-goal gl-positionXisMedium == 1)
    (up-compare-goal gl-positionYisLow == 1)
=>  
    (set-goal gl-wall-start-x 80)
    (set-goal gl-wall-start-y 40)
    (set-goal gl-wall-end-x 40)
    (set-goal gl-wall-end-y 40)
    (set-goal gl-wall-other-end-x 80)
    (set-goal gl-wall-other-end-y 0)
    (set-goal gl-wall-final-x 40)
    (set-goal gl-wall-final-y 0) 

     ; make wall smaller
    (up-modify-goal gl-wall-start-x c:- 3)
    (up-modify-goal gl-wall-start-y c:- 2)
    (up-modify-goal gl-wall-end-x c:+ 2)    
    (up-modify-goal gl-wall-end-y c:- 2) 
    (up-modify-goal gl-wall-other-end-x c:- 3)    
    (up-modify-goal gl-wall-final-x c:+ 2)   

    (set-goal gl-positionCode 6)     
    (chat-to-allies "IM AT THE NORTH WEST!")
    (disable-self)
)

; BOTTOM X
(defrule
    (up-compare-goal gl-positionXisLow == 1)
    (up-compare-goal gl-positionYisHigh == 1)
=>  
    (set-goal gl-wall-start-x 40)
    (set-goal gl-wall-start-y 80)
    (set-goal gl-wall-end-x 40)
    (set-goal gl-wall-end-y 120)
    (set-goal gl-wall-other-end-x 0)
    (set-goal gl-wall-other-end-y 80)
    (set-goal gl-positionCode 7)     
    (chat-to-allies "IM AT THE SOUTH, IN THE CORNER!")
    (disable-self)
)

(defrule
    (up-compare-goal gl-positionXisLow == 1)
    (up-compare-goal gl-positionYisMedium == 1)
=>  
    (set-goal gl-wall-start-x 40)
    (set-goal gl-wall-start-y 40)
    (set-goal gl-wall-end-x 40)
    (set-goal gl-wall-end-y 80)
    (set-goal gl-wall-other-end-x 0)
    (set-goal gl-wall-other-end-y 40)
    (set-goal gl-wall-final-x 0)
    (set-goal gl-wall-final-y 80)      
    (set-goal gl-positionCode 8)     
    (chat-to-allies "IM AT THE SOUTH WEST!")(disable-self)  
)  

(defrule
    (up-compare-goal gl-positionXisLow == 1)
    (up-compare-goal gl-positionYisLow == 1)
=>  
    (set-goal gl-wall-start-x 40)
    (set-goal gl-wall-start-y 40)
    (set-goal gl-wall-end-x 40)
    (set-goal gl-wall-end-y 0)
    (set-goal gl-wall-other-end-x 0)
    (set-goal gl-wall-other-end-y 40)
    (set-goal gl-positionCode 9)        
    (chat-to-allies "IM AT THE WEST, IN THE CORNER!")(disable-self)  
) 

(defrule
    (up-compare-goal gl-positionXisMedium == 1) 
    (up-compare-goal gl-positionYisMedium == 1)
    (can-build-wall 2 palisade-wall)
=>
    (build-wall 2 palisade-wall)
    (disable-self)    
)

(defrule
    (or
        (or
            (or
                    (up-compare-goal gl-positionCode == 9)
                    (up-compare-goal gl-positionCode == 2)
            )
            (or
                    (up-compare-goal gl-positionCode == 9)
                    (up-compare-goal gl-positionCode == 9)
            )
        )   
        (or
            (or
                    (up-compare-goal gl-positionCode == 5)
                    (up-compare-goal gl-positionCode == 9)
            )
            (or
                    (up-compare-goal gl-positionCode == 7)
                    (up-compare-goal gl-positionCode == 8)
            )
        )           
    )
    (building-type-count-total 793 == 0)
    (building-type-count-total palisade-wall == 0)
=>
    (up-build-line gl-wall-start-x gl-wall-end-x c: 793)
    (chat-local-to-self "BUILDING THE WALL GATES !")
)

(defrule    
    (or
        (or
            (or
                    (up-compare-goal gl-positionCode == 1)
                    (up-compare-goal gl-positionCode == 3)
            )
            (or
                    (up-compare-goal gl-positionCode == 6)
                    (up-compare-goal gl-positionCode == 4)
            )
        )   
        (or
            (or
                    (up-compare-goal gl-positionCode == 1)
                    (up-compare-goal gl-positionCode == 1)
            )
            (or
                    (up-compare-goal gl-positionCode == 1)
                    (up-compare-goal gl-positionCode == 1)
            )
        )           
    )
    (building-type-count-total 789 == 0)
    (building-type-count-total palisade-wall == 0)
=>
    (up-build-line gl-wall-start-x gl-wall-end-x c: 789)
    (chat-local-to-self "BUILDING THE WALL GATES !")
)


(defrule
    (can-build palisade-wall)
    ;(up-can-build-line 0 gl-wall-start-x c: palisade-wall)
=>
    (up-build-line gl-wall-start-x gl-wall-end-x c: palisade-wall)
    ;(chat-local-to-self "BUILDING THE WALL SECTION A !")
)

(defrule
    (can-build palisade-wall)
    (building-type-count palisade-wall > 14)
    ;(up-can-build-line 0 gl-wall-start-x c: palisade-wall)
=>
    (up-build-line gl-wall-start-x gl-wall-other-end-x c: palisade-wall)
    ;(chat-local-to-self "BUILDING THE WALL SECTION B !")
)

(defrule ; corners need no third wall
    (not
        (or
            (or
                (up-compare-goal gl-positionCode == 1)
                (up-compare-goal gl-positionCode == 3)
            )
            (or
                (up-compare-goal gl-positionCode == 7)
                (up-compare-goal gl-positionCode == 9)
            )
        )
    ) 
    (building-type-count palisade-wall > 18)
    ;(up-can-build-line 0 gl-wall-start-x c: palisade-wall)
    (can-build palisade-wall)    
=>
    (up-build-line gl-wall-end-x gl-wall-final-x c: palisade-wall)
    ;(chat-local-to-self "BUILDING THE WALL SECTION C !")
)

(defrule
    (building-type-count-total 793 < 3)
    ;(up-can-build-line gl-point-y gl-other-y c: 793)
=>
    ;(up-build-line gl-point-y gl-other-y c: palisade-gate)
    ;(up-build-line gl-point-y gl-other-y c: 798)    ;diagonal left-right
    ;(up-build-line gl-point-y gl-other-y c: 801)    ;diagonal north-south   
    ;(up-build-line gl-point-y gl-other-y c: 789)    ;along y axis
    ;(up-build-line gl-point-y gl-other-y c: 793)    ;along x axis
    ;(chat-to-player my-player-number "BUILDING THE GATES TO THE WALL FRONT")
    (do-nothing)
)

(defrule
    (building-type-count-total palisade-wall > 30)
    (building-type-count-total outpost < 12)    
    (up-can-build 0 c: outpost)
=>
    (up-set-placement-data my-player-number palisade-wall c: 12)
    (up-build place-control 0 c: outpost)
)

(defrule
    (building-type-count-total 793 > 1)
=>
    (delete-building 793)
)

(defrule
    (building-type-count-total 798 > 1)
=>
    (delete-building 798)
)

(defrule
    (building-type-count-total 793 > 0)
    (up-can-build 0 c: watch-tower-line)
=>
    (up-set-placement-data my-player-number 793 c: -3)
    (up-build place-control 0 c: watch-tower-line)
)

(defrule
    (building-type-count-total 798 > 0)
    (up-can-build 0 c: watch-tower-line)
=>
    (up-set-placement-data my-player-number 798 c: -3)
    (up-build place-control 0 c: watch-tower-line)
)