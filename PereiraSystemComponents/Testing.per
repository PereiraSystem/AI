; TESTING -------------------------------------------------------
(defrule(true)=>(chat-local-to-self "> 9. Testing Loaded")(disable-self))

; GUARD
(defrule
    (unit-type-count monk > 0)
=>	
    (up-full-reset-search)	
    (up-find-local c: spearman-line c: 1)
	;(up-find-local c: all-units-class c: 240)	
	;(up-remove-objects search-local object-data-hitpoints < 50)
    (up-guard-unit monk c: spearman-line)
)


; REMOVE CHEAP UNITS
(defrule
	(current-age == imperial-age)
    (population-headroom == 0)
    (housing-headroom == 0)
    (wood-amount > 1000)(food-amount > 1000)(gold-amount > 1000)
    (game-time > 2100); 35 min
    (unit-type-count skirmisher-line > 0)
    (can-train hand-cannoneer)    
=>
	(delete-unit skirmisher-line)
    (train hand-cannoneer)
    (chat-local-to-self "'CHANGING' SKIRMISHERS FOR HAND CANNONEERS")
)

(defrule
	(current-age == imperial-age)
    (population-headroom == 0)
    (housing-headroom == 0)
    (wood-amount > 1300)(food-amount > 1300)(gold-amount > 1300)
    (game-time > 2100); 35 min
    (not(civ-selected gothic))(not(civ-selected japanese))    
    (unit-type-count spearman-line > 0)
    (can-train knight-line)    
=>
	(delete-unit spearman)(delete-unit pikeman)(delete-unit halberdier)
    (train knight-line)
    (chat-local-to-self "'CHANGING' SPEARMEN FOR KNIGHTS")
)

(defrule
	(not	(player-in-game any-ally))
	(unit-type-count trade-cart > 0)
=>
	(delete-unit trade-cart)
)

; USER PATCH WALL
(defconst gl-positionXisHigh 470) 
(defconst gl-positionXisMedium 471)
(defconst gl-positionXisLow 472)
(defconst gl-positionYisHigh 473) 
(defconst gl-positionYisMedium 474)
(defconst gl-positionYisLow 475)
(defconst gl-myPosition-x 476)
(defconst gl-myPosition-y 477)
(defconst gl-center-x 492)
(defconst gl-center-y 493)
(defconst gl-buildingInnerWall 495)

(defconst gl-wallPoint1-x 501)
(defconst gl-wallPoint1-y 502)
(defconst gl-wallPoint2-x 503)
(defconst gl-wallPoint2-y 504)
(defconst gl-wallPoint3-x 505)
(defconst gl-wallPoint3-y 506)
(defconst gl-wallPoint4-x 507)
(defconst gl-wallPoint4-y 508)
(defconst gl-mapSizeThird 509)
(defconst gl-mapSizeTwoThirds 510)

(defrule
    (true) ;just in case
=>
    (set-goal gl-positionXisHigh 0) 
    (set-goal gl-positionXisMedium 0)
    (set-goal gl-positionXisLow 0)
    (set-goal gl-positionYisHigh 0) 
    (set-goal gl-positionYisMedium 0)
    (set-goal gl-positionYisLow 0)
    (set-goal gl-myPosition-x 0)
    (set-goal gl-myPosition-y 0)
    (set-goal gl-buildingInnerWall 0)       
    (set-goal gl-mapSizeThird 0)         
    (set-goal gl-mapSizeTwoThirds 0) 
    (disable-self)  
)
(defrule
    (true) ;just in case
=>
    (set-goal gl-wallPoint1-x 0)
    (set-goal gl-wallPoint1-y 0)
    (set-goal gl-wallPoint2-x 0)
    (set-goal gl-wallPoint2-y 0)
    (set-goal gl-wallPoint3-x 0)
    (set-goal gl-wallPoint3-y 0)
    (set-goal gl-wallPoint4-x 0)
    (set-goal gl-wallPoint4-y 0)
    (set-goal gl-mapSizeThird 0)
    (disable-self)
)
(defrule
    (true)
=>
    (up-get-point position-self gl-myPosition-x)
    (up-get-point position-map-size gl-mapSizeThird)
    (up-get-point position-map-size gl-mapSizeTwoThirds)    
    (up-modify-goal gl-mapSizeThird c:/ 3)
    (up-modify-goal gl-mapSizeTwoThirds c:/ 3)
    (up-modify-goal gl-mapSizeTwoThirds c:* 2)    
    (up-chat-data-to-all "map size 1/3 %d" g: gl-mapSizeThird)
    (up-chat-data-to-all "map size 2/3 %d" g: gl-mapSizeTwoThirds)
    (up-chat-data-to-all "map size %d" g: position-map-size)      
    (disable-self)   
)

; CHECK OUR POSITION - BASIC POINTS
; HIGH
(defrule
    (up-compare-goal gl-myPosition-x g:>= gl-mapSizeTwoThirds)
=>
    (set-goal gl-positionXisHigh 1)(disable-self)  
)
(defrule
    (up-compare-goal gl-myPosition-y g:>= gl-mapSizeTwoThirds)
=>
    (set-goal gl-positionYisHigh 1)(disable-self)  
)
; MID
(defrule
    (up-compare-goal gl-myPosition-x g:< gl-mapSizeTwoThirds)
    (up-compare-goal gl-myPosition-x g:> gl-mapSizeThird)
=>
    (set-goal gl-positionXisMedium 1)(disable-self)  
)
(defrule
    (up-compare-goal gl-myPosition-y g:< gl-mapSizeTwoThirds)
    (up-compare-goal gl-myPosition-y g:> gl-mapSizeThird)
=>
    (set-goal gl-positionYisMedium 1)(disable-self)  
)

; BOTTOM
(defrule
    (up-compare-goal gl-myPosition-x g:<= gl-mapSizeThird)
=>
    (set-goal gl-positionXisLow 1)(disable-self)  
)
(defrule
    (up-compare-goal gl-myPosition-y g:<= gl-mapSizeThird)
=>
    (set-goal gl-positionYisLow 1)(disable-self)  
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 0)
=>    
    (up-get-point position-self gl-wallPoint1-x)
    (up-get-point position-self gl-wallPoint2-x)
    (up-get-point position-self gl-wallPoint3-x)
    (up-get-point position-self gl-wallPoint4-x)

    (up-modify-goal gl-wallPoint1-x c:+ 22) ; 1 north
    (up-modify-goal gl-wallPoint1-y c:- 22) 

    (up-modify-goal gl-wallPoint2-x c:+ 22) ; 2 east
    (up-modify-goal gl-wallPoint2-y c:+ 22) 

    (up-modify-goal gl-wallPoint3-x c:- 22) ; 3 south
    (up-modify-goal gl-wallPoint3-y c:+ 22) 

    (up-modify-goal gl-wallPoint4-x c:- 22) ; 4 west
    (up-modify-goal gl-wallPoint4-y c:- 22)  
    (disable-self)           
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 1) ; inner wall
=>    
    (up-get-point position-self gl-wallPoint1-x)
    (up-get-point position-self gl-wallPoint2-x)
    (up-get-point position-self gl-wallPoint3-x)
    (up-get-point position-self gl-wallPoint4-x)

    (up-modify-goal gl-wallPoint1-x c:+ 19) ; 1 north
    (up-modify-goal gl-wallPoint1-y c:- 19) 

    (up-modify-goal gl-wallPoint2-x c:+ 19) ; 2 east
    (up-modify-goal gl-wallPoint2-y c:+ 19) 

    (up-modify-goal gl-wallPoint3-x c:- 19) ; 3 south
    (up-modify-goal gl-wallPoint3-y c:+ 19) 

    (up-modify-goal gl-wallPoint4-x c:- 19) ; 4 west
    (up-modify-goal gl-wallPoint4-y c:- 19)  
    (disable-self)           
)

(defrule
    (false) ; "romboid" wall
=>    
    (up-get-point position-self gl-wallPoint1-x)
    (up-get-point position-self gl-wallPoint2-x)
    (up-get-point position-self gl-wallPoint3-x)
    (up-get-point position-self gl-wallPoint4-x)

    (up-modify-goal gl-wallPoint1-x c:+ 20) ; 1 north
    (up-modify-goal gl-wallPoint1-y c:- 20) 

    (up-modify-goal gl-wallPoint2-x c:+ 20) ; 2 east
    (up-modify-goal gl-wallPoint2-y c:+ 20) 

    (up-modify-goal gl-wallPoint3-x c:- 20) ; 3 south
    (up-modify-goal gl-wallPoint3-y c:+ 20) 

    (up-modify-goal gl-wallPoint4-x c:- 20) ; 4 west
    (up-modify-goal gl-wallPoint4-y c:- 20)  
    (disable-self)           
)

; avoid building a wall next to abyss
(defrule ; x is veryx low
    (false)
    (up-compare-goal gl-wallPoint1-y < 10)
=> 
    (set-goal gl-wallPoint1-x 0)
)

; 9 POSITIONS
(defrule
    (up-compare-goal gl-positionXisHigh == 1)(up-compare-goal gl-positionYisHigh == 1)
    (game-time > 2)
=>    
    (chat-to-allies "IM AT THE EAST, IN THE CORNER!")(disable-self)
)
(defrule
    (up-compare-goal gl-positionXisHigh == 1)(up-compare-goal gl-positionYisMedium == 1)
    (game-time > 4)
=>  
    (chat-to-allies "IM AT THE NORTH EAST!")(disable-self)  
)
(defrule
    (up-compare-goal gl-positionXisHigh == 1)(up-compare-goal gl-positionYisLow == 1)
    (game-time > 6)
=>  
    (chat-to-allies "IM AT AT THE NORTH, IN THE CORNER!")(disable-self)  
)
(defrule
    (up-compare-goal gl-positionXisMedium == 1)(up-compare-goal gl-positionYisHigh == 1)
    (game-time > 8)
=>  
    (chat-to-allies "IM AT THE SOUTH EAST!")(disable-self)
)
(defrule
    (up-compare-goal gl-positionXisMedium == 1)(up-compare-goal gl-positionYisMedium == 1)
=>  
    (chat-to-allies "IM IN THE MIDDLE OF THE MAP")(disable-self)
)
(defrule
    (up-compare-goal gl-positionXisMedium == 1)(up-compare-goal gl-positionYisLow == 1)
    (game-time > 13)
=>  
    (chat-to-allies "IM AT THE NORTH WEST!")(disable-self)
)
(defrule
    (up-compare-goal gl-positionXisLow == 1)(up-compare-goal gl-positionYisHigh == 1)
    (game-time > 14)
=> 
    (chat-to-allies "IM AT THE SOUTH, IN THE CORNER!")(disable-self)
) 
(defrule
    (up-compare-goal gl-positionXisLow == 1)(up-compare-goal gl-positionYisMedium == 1)
    (game-time > 16)
=>
    (chat-to-allies "IM AT THE SOUTH WEST!")(disable-self)  
)    
(defrule
    (up-compare-goal gl-positionXisLow == 1)(up-compare-goal gl-positionYisLow == 1)
=>     
    (chat-to-allies "IM AT THE WEST, IN THE CORNER!")(disable-self)  
) 

; GATES Y AXIS
(defrule
    (wood-amount g:> gl-minimumWoodForLC)     
    (building-type-count-total 793 < 2)
    (building-type-count-total palisade-wall == 0)
=>
    (up-build-line gl-wallPoint1-x gl-wallPoint2-x c: 793)
    (chat-local-to-self "BUILDING THE WALL GATES!")
)

(defrule
    (wood-amount g:> gl-minimumWoodForLC)     
    (building-type-count-total 789 < 3)
    (building-type-count-total palisade-wall == 0)
=>
    (up-build-line gl-wallPoint2-x gl-wallPoint3-x c: 789)
    (chat-local-to-self "BUILDING THE WALL GATES!")
)

(defrule
    (wood-amount g:> gl-minimumWoodForLC)     
    (building-type-count-total 793 < 4)
    (building-type-count-total palisade-wall == 0)
=>
    (up-build-line gl-wallPoint3-x gl-wallPoint4-x c: 793)
    (chat-local-to-self "BUILDING THE WALL GATES!")
)

(defrule
    (wood-amount g:> gl-minimumWoodForLC)     
    (building-type-count-total 789 < 5)
    (building-type-count-total palisade-wall == 0)
=>
    (up-build-line gl-wallPoint2-x gl-wallPoint3-x c: 789)
    (chat-local-to-self "BUILDING THE WALL GATES!")
)

; FINISHED GATES, NOW THE PALISADE
(defrule ;along Y axis, right side
    (up-compare-goal gl-buildingInnerWall == 0)
    (unit-type-count-total villager > 5)
    (building-type-count-total barracks > 0)     
    (wood-amount > 200) 
=>    
    (up-build-line gl-wallPoint1-x gl-wallPoint2-x c: palisade-wall)
    (set-strategic-number sn-defense-distance 40)
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 0)
    (unit-type-count-total villager > 6)
    (building-type-count-total barracks > 0)     
    (building-type-count palisade-wall > 4)
    (wood-amount > 200)   
=>
    (up-build-line gl-wallPoint2-x gl-wallPoint3-x c: palisade-wall)
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 0)
    (unit-type-count-total villager > 7)
    (building-type-count-total barracks > 0)      
    (wood-amount > 200)    
    (building-type-count palisade-wall > 8)  
=>
    (up-build-line gl-wallPoint3-x gl-wallPoint4-x c: palisade-wall)
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 0)
    (unit-type-count-total villager > 7)
    (building-type-count-total barracks > 0)      
    (wood-amount > 200)    
    (building-type-count palisade-wall > 8)  
=>
    (up-build-line gl-wallPoint4-x gl-wallPoint1-x c: palisade-wall)
)

(defrule
    (current-age == castle-age)  
=>
    (set-goal gl-buildingInnerWall == 1)
)

; FINISHED GATES, NOW THE stonewa
(defrule ;along Y axis, right side
    (up-compare-goal gl-buildingInnerWall == 1)
=>    
    (up-build-line gl-wallPoint1-x gl-wallPoint2-x c: stone-wall-line)
    (set-strategic-number sn-defense-distance 40)
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 1)
=>
    (up-build-line gl-wallPoint2-x gl-wallPoint3-x c: stone-wall-line)
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 1) 
=>
    (up-build-line gl-wallPoint3-x gl-wallPoint4-x c: stone-wall-line)
)

(defrule
    (up-compare-goal gl-buildingInnerWall == 1)
=>
    (up-build-line gl-wallPoint4-x gl-wallPoint1-x c: stone-wall-line)
)

; some outposts
(defrule
    (building-type-count-total palisade-wall > 30)
    (wood-amount g:> gl-minimumWoodForLC)
    (building-type-count-total outpost < 5)    
    (up-can-build 0 c: outpost)
=>
    (up-set-placement-data my-player-number town-center c: 12)
    (up-build place-control 0 c: outpost)
)

(defrule
    (building-type-count 793 > 7)(game-time > 333)
=>
    (delete-building 793)
    (chat-local-to-self "TOO MANY GATES! DESTROY THAT!")
)

(defrule
    (building-type-count 789 > 7)
    (game-time > 333)
=>
    (delete-building 789)
    (chat-local-to-self "TOO MANY GATES! DESTROY THAT!")    
)

(defrule
    (building-type-count-total 793 > 0)
    (wood-amount g:> gl-minimumWoodForLC)
    (building-type-count-total watch-tower-line < 4)       
    (up-can-build 0 c: watch-tower-line)
=>
    (up-set-placement-data my-player-number 793 c: -3)
    (up-build place-control 0 c: watch-tower-line)
)

(defrule
    ;(building-type-count-total 789 > 0)
    (building-type-count-total palisade-wall > 0)
    (wood-amount g:> gl-minimumWoodForLC) 
    (building-type-count-total watch-tower-line < 4)      
    (up-can-build 0 c: watch-tower-line)
=>
    ;(up-set-placement-data my-player-number 789 c: -3)
    (up-set-placement-data my-player-number palisade-wall c: -3)
    (up-build place-control 0 c: watch-tower-line)
)

(defrule
    (cheats-enabled)
=>
    (chat-to-all "LET´S SAVE TIME WITH 'AEGIS' CHEAT!")
    (up-cc-send-cheat "aegis")
    (disable-self)
)